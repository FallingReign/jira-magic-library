#!/bin/sh
#
# Pre-commit hook for workflow validation
# Runs validation before commit to catch issues early
#
# Install: npm run install:hooks
#

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo "${BLUE}üîç Running workflow validation...${NC}\n"

# Check if story/backlog files changed
CHANGED_FILES=$(git diff --cached --name-only)
STORY_FILES=$(echo "$CHANGED_FILES" | grep -E "(docs/stories/|docs/backlog.md)")

if [ -z "$STORY_FILES" ]; then
  echo "${GREEN}‚úì No story/backlog files changed, skipping validation${NC}\n"
  exit 0
fi

echo "${BLUE}Changed story/backlog files:${NC}"
echo "$STORY_FILES" | sed 's/^/  - /'
echo ""

# Run validation (validator will auto-detect if coverage check is needed)
node scripts/validate-workflow.js
VALIDATION_EXIT_CODE=$?

echo ""

# Handle results
if [ $VALIDATION_EXIT_CODE -eq 0 ]; then
  echo "${GREEN}‚úÖ Validation passed!${NC}"
  echo ""
  exit 0
else
  echo "${YELLOW}‚ö†Ô∏è  Validation found issues (see above)${NC}"
  echo ""
  echo "${YELLOW}You can still commit, but please fix issues before pushing.${NC}"
  echo ""
  echo "Options:"
  echo "  1. ${GREEN}Fix issues now${NC} (recommended) - Ctrl+C to abort, fix, then commit again"
  echo "  2. ${YELLOW}Commit anyway${NC} - Issues will be caught by CI"
  echo ""
  
  # Prompt user
  printf "Continue with commit? [y/N] "
  read -r response
  
  case "$response" in
    [yY][eE][sS]|[yY]) 
      echo "${YELLOW}‚ö†Ô∏è  Committing with validation issues...${NC}"
      exit 0
      ;;
    *)
      echo "${RED}‚ùå Commit aborted. Please fix validation issues.${NC}"
      exit 1
      ;;
  esac
fi
